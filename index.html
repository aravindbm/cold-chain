<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission: Cold Chain Guardian Pro</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --light: #ecf0f1;
            --basket-color: #d6eaf8; /* Top of ILR */
            --floor-color: #aed6f1; /* Bottom of ILR */
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 900px; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Headers & Utility */
        h1, h2 { color: var(--primary); margin-top: 0; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--light); padding-bottom: 10px; margin-bottom: 20px; }
        .timer { font-size: 1.2rem; font-weight: bold; color: var(--danger); background: #fadbd8; padding: 5px 15px; border-radius: 20px; }
        .score-display { font-size: 1.2rem; font-weight: bold; color: var(--success); }
        .btn { background-color: var(--accent); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: 0.3s; display: inline-block; }
        .btn:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .btn:hover:not(:disabled) { background-color: #1a5276; }
        .screen { display: none; }
        .active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Login & Report */
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .report-score-box { text-align: center; padding: 20px; background: var(--primary); color: white; border-radius: 8px; margin-bottom: 20px; }
        .report-score-big { font-size: 3rem; font-weight: bold; }

        /* Station Styles: MCQ */
        .options-grid { display: grid; gap: 10px; }
        .btn-option { text-align: left; background: white; color: var(--primary); border: 2px solid var(--light); width: 100%; }
        .btn-option:hover { border-color: var(--accent); background: #ebf5fb; }
        .feedback { margin-top: 15px; padding: 15px; border-radius: 6px; display: none; }
        .feedback.good { background: #d4efdf; color: #145a32; border-left: 5px solid var(--success); }
        .feedback.bad { background: #fadbd8; color: #7b241c; border-left: 5px solid var(--danger); }

        /* Station 2: Matching Game */
        .match-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .match-col { flex: 1; min-width: 250px; }
        .draggable-item { background: var(--accent); color: white; padding: 10px; margin: 5px 0; border-radius: 4px; cursor: grab; }
        .drop-target { background: #f8f9f9; border: 2px dashed #bdc3c7; padding: 15px; margin: 5px 0; border-radius: 4px; min-height: 40px; display: flex; align-items: center; justify-content: space-between; }
        .drop-target.filled { border-style: solid; border-color: var(--success); background: #e8f8f5; }

        /* Station 4: ILR Tetris */
        .ilr-diagram { display: flex; flex-direction: column; height: 400px; border: 4px solid #5d6d7e; border-radius: 10px; margin-top: 20px; position: relative; }
        .ilr-zone { flex: 1; padding: 10px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; transition: 0.3s; }
        .ilr-top { background: var(--basket-color); border-bottom: 2px dashed #abb2b9; position: relative; }
        .ilr-top::after { content: "TOP / BASKET (Freeze Sensitive)"; position: absolute; right: 10px; top: 10px; font-size: 0.8rem; opacity: 0.5; font-weight: bold; }
        .ilr-bottom { background: var(--floor-color); position: relative; }
        .ilr-bottom::after { content: "BOTTOM / FLOOR (Heat Sensitive)"; position: absolute; right: 10px; bottom: 10px; font-size: 0.8rem; opacity: 0.5; font-weight: bold; }
        
        .vaccine-queue { display: flex; gap: 10px; padding: 15px; background: #eee; border-radius: 8px; overflow-x: auto; min-height: 60px; margin-bottom: 10px; }
        .vial { width: 50px; height: 50px; background: white; border: 2px solid var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.7rem; cursor: grab; user-select: none; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .vial.correct { border-color: var(--success); background: #d4efdf; }
        .vial.incorrect { border-color: var(--danger); background: #fadbd8; }

    </style>
</head>
<body>

<div class="container">
    
    <div id="screen-login" class="screen active">
        <h1>Mission: Cold Chain Guardian Pro</h1>
        <p><strong>Context:</strong> You are a Medical Officer managing the Cold Chain Point.</p>
        <p><strong>Format:</strong> 5 Stations | Maximum Score: 100</p>
        <hr>
        <div style="margin-bottom: 20px;">
            <label>Name</label> <input type="text" id="pName" placeholder="Candidate Name">
            <label>Roll No</label> <input type="text" id="pRoll" placeholder="Roll Number">
        </div>
        <button class="btn" onclick="initGame()">Start Assessment</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="header-bar">
            <span>Candidate: <strong id="dispName"></strong></span>
            <span class="timer" id="timer">00:00</span>
        </div>
        
        <div id="game-content">
            </div>

        <div id="feedback-area" class="feedback"></div>
        <div style="text-align: right; margin-top: 20px;">
            <button id="action-btn" class="btn" onclick="submitAnswer()">Submit Answer</button>
        </div>
    </div>

    <div id="screen-report" class="screen">
        <div class="report-score-box">
            <div>FINAL SCORE</div>
            <div class="report-score-big"><span id="finalScore">0</span>/100</div>
        </div>
        <h2>Performance Summary</h2>
        <p><strong>Candidate:</strong> <span id="repName"></span> (<span id="repRoll"></span>)</p>
        <p><strong>Time Taken:</strong> <span id="repTime"></span></p>
        
        <div id="log-container"></div>
        <br>
        <button class="btn" onclick="location.reload()">Restart Assessment</button>
    </div>

</div>

<script>
    /* --- DATA & CONFIG --- */
    // PASTE YOUR GOOGLE DEPLOYMENT URL INSIDE THE QUOTES BELOW
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwW8_Bf7LEsGgL0lwb3t_IOG_tZKFgtg-xXVMAa3o0xTbPwZbx9T6ew4e1JvWWdQ_KV/exec";
    const STATIONS = [
        {
            id: 1,
            title: "Station 1: The Basics (Concept Check)",
            type: "mcq",
            pool: [
                {
                    q: "What is the recommended temperature range for the Ice Lined Refrigerator (ILR) at the PHC?",
                    options: ["-15°C to -25°C", "+2°C to +8°C", "0°C to +4°C", "Room Temperature"],
                    correct: 1,
                    expl: "The standard storage temp for vaccines at PHC (ILR) is +2°C to +8°C."
                },
                {
                    q: "The Cold Chain ends at which point?",
                    options: ["The District Store", "The PHC ILR", "The Beneficiary", "The Vaccine Carrier"],
                    correct: 2,
                    expl: "The Cold Chain begins at manufacture and must be maintained until the vaccine enters the beneficiary."
                }
            ]
        },
        {
            id: 2,
            title: "Station 2: The Equipment Room",
            type: "match",
            maxScore: 20,
            items: [
                { id: "ilr", label: "ILR", target: "Main storage at PHC (+2 to +8)" },
                { id: "df", label: "Deep Freezer", target: "Preparation of Ice Packs" },
                { id: "carrier", label: "Vaccine Carrier", target: "Carrying small qty to Sub-center" },
                { id: "day", label: "Day Carrier", target: "Used for nearby sessions (2 vials)" }
            ]
        },
        {
            id: 3,
            title: "Station 3: The Vial Validator",
            type: "mcq",
            pool: [
                {
                    q: "You are reconstituting the MEASLES (MR) vaccine. Which diluent do you choose?",
                    options: ["Normal Saline", "Phosphate Buffer", "Sterile Water", "Distilled Water"],
                    correct: 2,
                    expl: "Measles/MR always uses Sterile Water. (BCG uses Saline, JE uses Buffer)."
                },
                {
                    q: "Which of the following is a FREEZE DRIED (Lyophilized) vaccine?",
                    options: ["Pentavalent", "Hepatitis B", "BCG", "IPV"],
                    correct: 2,
                    expl: "BCG is freeze dried (powder) and requires reconstitution."
                }
            ]
        },
        {
            id: 4,
            title: "Station 4: ILR Tetris (Visual Sort)",
            type: "tetris",
            maxScore: 30, // High stakes
            vials: [
                { name: "Hep B", type: "freeze_sensitive" },
                { name: "OPV", type: "heat_sensitive" },
                { name: "Penta", type: "freeze_sensitive" },
                { name: "Measles", type: "heat_sensitive" },
                { name: "Td", type: "freeze_sensitive" },
                { name: "BCG", type: "heat_sensitive" }
            ]
        },
        {
            id: 5,
            title: "Station 5: The Shake Test (Quality Control)",
            type: "mcq",
            pool: [
                {
                    q: "Shake Test Result: The suspect vial settles FASTER than the control vial, and the fluid is CLEAR. Conclusion?",
                    options: ["Passed: Use Vaccine", "Failed: Discard Vaccine", "Indeterminate: Retest"],
                    correct: 1,
                    expl: "Fast settling + Clear supernatant = Frozen/Damaged. Discard."
                },
                {
                    q: "Shake Test Result: The suspect vial settles SLOWER than the control vial, and the fluid is CLOUDY. Conclusion?",
                    options: ["Passed: Use Vaccine", "Failed: Discard Vaccine", "Indeterminate: Retest"],
                    correct: 0,
                    expl: "Slow settling + Cloudy = Not frozen. Safe to use."
                }
            ]
        }
    ];

    /* --- STATE --- */
    let currentStnIndex = 0;
    let totalScore = 0;
    let startTime;
    let activeQuestion = null; // Holds the specific random Q chosen
    let actionLogs = [];

    /* --- INIT --- */
    function initGame() {
        const n = document.getElementById('pName').value;
        const r = document.getElementById('pRoll').value;
        if(!n || !r) { alert("Please identify yourself."); return; }
        
        document.getElementById('dispName').textContent = n;
        document.getElementById('screen-login').classList.remove('active');
        document.getElementById('screen-game').classList.add('active');
        
        startTime = new Date();
        setInterval(() => {
            const now = new Date();
            const diff = Math.floor((now - startTime)/1000);
            const m = Math.floor(diff/60).toString().padStart(2,'0');
            const s = (diff%60).toString().padStart(2,'0');
            document.getElementById('timer').textContent = `${m}:${s}`;
        }, 1000);

        loadStation();
    }

    /* --- RENDER LOGIC --- */
    function loadStation() {
        const stn = STATIONS[currentStnIndex];
        const container = document.getElementById('game-content');
        const feedback = document.getElementById('feedback-area');
        const btn = document.getElementById('action-btn');
        
        container.innerHTML = `<h2>${stn.title}</h2>`;
        feedback.style.display = 'none';
        feedback.className = 'feedback';
        btn.textContent = "Submit Answer";
        btn.onclick = submitAnswer;
        btn.style.display = 'inline-block';

        // LOGIC BRANCHING
        if (stn.type === "mcq") {
            renderMCQ(stn, container);
        } else if (stn.type === "match") {
            renderMatch(stn, container);
        } else if (stn.type === "tetris") {
            renderTetris(stn, container);
        }
    }

    function renderMCQ(stn, container) {
        // Pick random Q
        const qIndex = Math.floor(Math.random() * stn.pool.length);
        activeQuestion = stn.pool[qIndex];
        
        let html = `<p style="font-size:1.2rem">${activeQuestion.q}</p><div class="options-grid">`;
        activeQuestion.options.forEach((opt, i) => {
            html += `<button class="btn btn-option" onclick="selectOption(this, ${i})">${opt}</button>`;
        });
        html += `</div>`;
        container.innerHTML += html;
    }

    let selectedOptionIndex = -1;
    function selectOption(btn, index) {
        if(document.getElementById('feedback-area').style.display === 'block') return; // Locked
        document.querySelectorAll('.btn-option').forEach(b => b.style.borderColor = '#ecf0f1');
        btn.style.borderColor = '#2980b9';
        selectedOptionIndex = index;
    }

    /* --- MATCHING LOGIC --- */
    function renderMatch(stn, container) {
        let html = `<p>Drag the equipment (Blue) to its correct function description.</p>
        <div class="match-container">
            <div class="match-col" id="source-col">
                </div>
            <div class="match-col" id="target-col">
                </div>
        </div>`;
        container.innerHTML += html;

        // Shuffle items
        const shuffledItems = [...stn.items].sort(() => Math.random() - 0.5);
        const shuffledTargets = [...stn.items].sort(() => Math.random() - 0.5);

        const srcDiv = document.getElementById('source-col');
        const tgtDiv = document.getElementById('target-col');

        shuffledItems.forEach(item => {
            const el = document.createElement('div');
            el.className = 'draggable-item';
            el.draggable = true;
            el.textContent = item.label;
            el.id = item.id;
            el.ondragstart = (ev) => { ev.dataTransfer.setData("text", ev.target.id); };
            srcDiv.appendChild(el);
        });

        shuffledTargets.forEach(item => {
            const el = document.createElement('div');
            el.className = 'drop-target';
            el.dataset.correctId = item.id; // Secretly store correct answer
            el.innerHTML = `<span>${item.target}</span> <span class="slot">___</span>`;
            el.ondragover = (ev) => ev.preventDefault();
            el.ondrop = dropMatch;
            tgtDiv.appendChild(el);
        });
    }

    function dropMatch(ev) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");
        const draggedEl = document.getElementById(data);
        // Find closest drop target
        const targetEl = ev.target.closest('.drop-target');
        
        if (targetEl && !targetEl.dataset.filled) {
            targetEl.querySelector('.slot').textContent = draggedEl.textContent;
            targetEl.dataset.filled = data; // Store the ID of what was dropped
            draggedEl.style.display = 'none'; // Hide original
        }
    }

    /* --- TETRIS LOGIC --- */
    function renderTetris(stn, container) {
        let html = `
        <p><strong>Instructions:</strong> Drag the vials into the ILR. <br>
        <span style="color:var(--basket-color)">Top/Basket:</span> Freeze Sensitive (T-series, HepB).<br>
        <span style="color:var(--floor-color)">Bottom/Floor:</span> Heat Sensitive (Live vaccines).</p>
        
        <div class="vaccine-queue" id="v-queue"></div>
        
        <div class="ilr-diagram">
            <div class="ilr-zone ilr-top" id="zone-top" ondragover="allowDrop(event)" ondrop="dropTetris(event, 'top')"></div>
            <div class="ilr-zone ilr-bottom" id="zone-bottom" ondragover="allowDrop(event)" ondrop="dropTetris(event, 'bottom')"></div>
        </div>`;
        container.innerHTML += html;

        const queue = document.getElementById('v-queue');
        stn.vials.forEach((v, i) => {
            const el = document.createElement('div');
            el.className = 'vial';
            el.draggable = true;
            el.textContent = v.name;
            el.id = `vial-${i}`;
            el.dataset.type = v.type;
            el.ondragstart = (ev) => {
                ev.dataTransfer.setData("id", el.id);
                ev.dataTransfer.setData("type", v.type);
            };
            queue.appendChild(el);
        });
    }

    function allowDrop(ev) { ev.preventDefault(); }
    
    function dropTetris(ev, zone) {
        ev.preventDefault();
        const id = ev.dataTransfer.getData("id");
        const type = ev.dataTransfer.getData("type");
        const el = document.getElementById(id);
        
        // Visual Logic
        el.style.position = 'relative'; // Reset
        ev.target.appendChild(el);
        
        // Store user choice on the element
        el.dataset.userChoice = zone; 
    }

    /* --- SUBMISSION ENGINE --- */
    function submitAnswer() {
        const stn = STATIONS[currentStnIndex];
        const feedback = document.getElementById('feedback-area');
        const btn = document.getElementById('action-btn');
        
        if(btn.textContent === "Next Station") {
            nextStation();
            return;
        }
        
        let scoreGain = 0;
        let msg = "";
        let isPass = false;

        // --- MCQ CHECK ---
        if (stn.type === "mcq") {
            if(selectedOptionIndex === -1) { alert("Select an option."); return; }
            if(selectedOptionIndex === activeQuestion.correct) {
                scoreGain = 20; // Standard 20pts per MCQ
                msg = "Correct! " + activeQuestion.expl;
                feedback.className = "feedback good";
                isPass = true;
            } else {
                msg = "Incorrect. " + activeQuestion.expl;
                feedback.className = "feedback bad";
            }
        }
        
        // --- MATCH CHECK ---
        else if (stn.type === "match") {
            const targets = document.querySelectorAll('.drop-target');
            let correctCount = 0;
            let total = targets.length;
            
            targets.forEach(t => {
                const filledId = t.dataset.filled;
                const correctId = t.dataset.correctId;
                if(filledId === correctId) {
                    correctCount++;
                    t.style.border = "2px solid green";
                } else {
                    t.style.border = "2px solid red";
                }
            });
            
            scoreGain = (correctCount / total) * stn.maxScore;
            msg = `You matched ${correctCount}/${total} correctly.`;
            feedback.className = scoreGain === stn.maxScore ? "feedback good" : "feedback bad";
            isPass = correctCount === total;
        }

        // --- TETRIS CHECK ---
        else if (stn.type === "tetris") {
            const vials = document.querySelectorAll('.vial');
            let correctCount = 0;
            let total = vials.length;
            let detailErr = "";

            vials.forEach(v => {
                const choice = v.dataset.userChoice; // top or bottom
                const type = v.dataset.type; // freeze_sensitive or heat_sensitive
                
                // Logic: Freeze Sensitive MUST go Top. Heat Sensitive MUST go Bottom.
                let correctZone = (type === 'freeze_sensitive') ? 'top' : 'bottom';
                
                if(choice === correctZone) {
                    correctCount++;
                    v.classList.add('correct');
                } else {
                    v.classList.add('incorrect');
                    detailErr += `[${v.textContent} should be ${correctZone.toUpperCase()}] `;
                }
            });

            scoreGain = (correctCount / total) * stn.maxScore;
            msg = `You placed ${correctCount}/${total} correctly. ${detailErr}`;
            feedback.className = scoreGain === stn.maxScore ? "feedback good" : "feedback bad";
            isPass = correctCount === total;
        }

        // Finalize Step
        totalScore += Math.round(scoreGain);
        feedback.innerHTML = `<strong>Result:</strong> ${msg} <br>Score added: ${Math.round(scoreGain)}`;
        feedback.style.display = 'block';
        
        actionLogs.push({
            station: stn.title,
            score: Math.round(scoreGain),
            max: stn.maxScore || 20,
            status: isPass ? "Pass" : "Review"
        });

        btn.textContent = "Next Station";
        
        // If last station, change button
        if(currentStnIndex === STATIONS.length -1) {
            btn.textContent = "Finish Assessment";
            btn.onclick = finishGame;
        }
    }

    function nextStation() {
        currentStnIndex++;
        selectedOptionIndex = -1;
        loadStation();
    }

    function finishGame() {
        // 1. Switch Screens
        document.getElementById('screen-game').classList.remove('active');
        document.getElementById('screen-report').classList.add('active');
        
        // 2. Gather Data
        const pName = document.getElementById('pName').value;
        const pRoll = document.getElementById('pRoll').value;
        const pTime = document.getElementById('timer').textContent;
        
        // 3. Update UI Report
        document.getElementById('repName').textContent = pName;
        document.getElementById('repRoll').textContent = pRoll;
        document.getElementById('finalScore').textContent = totalScore;
        document.getElementById('repTime').textContent = pTime;

        // Render detailed log table
        const logDiv = document.getElementById('log-container');
        let html = `<table style="width:100%; border-collapse:collapse; text-align:left; margin-top:20px;">
            <tr style="background:#ecf0f1;"><th>Station</th><th>Score</th><th>Status</th></tr>`;
        
        actionLogs.forEach(log => {
            html += `<tr>
                <td style="border:1px solid #ddd; padding:8px;">${log.station}</td>
                <td style="border:1px solid #ddd; padding:8px;">${log.score} / ${log.max}</td>
                <td style="border:1px solid #ddd; padding:8px; color:${log.status==='Pass'?'green':'red'}">${log.status}</td>
            </tr>`;
        });
        html += `</table>`;
        
        // Add a Status Message area
        html += `<p id="upload-status" style="margin-top:10px; font-weight:bold; color:gray;">Syncing results to cloud...</p>`;
        logDiv.innerHTML = html;

        // 4. Send Data to Google Sheet
        if(GOOGLE_SCRIPT_URL) {
            const payload = {
                name: pName,
                roll: pRoll,
                score: totalScore,
                time: pTime
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors", // Essential for Google Scripts to accept data from external forms
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            }).then(() => {
                document.getElementById('upload-status').innerText = "✅ Result successfully saved to Database.";
                document.getElementById('upload-status').style.color = "green";
            }).catch(err => {
                console.error(err);
                document.getElementById('upload-status').innerText = "⚠️ Saved locally, but cloud sync failed.";
            });
        }
    }
</script>
</body>
</html>

